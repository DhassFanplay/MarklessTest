<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AR.js Markerless Cube Placement</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js "></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js "></script>
  <style>
    body,
    html {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    #placeButton {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      font-size: 16px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 10px;
      z-index: 1000;
      display: none;
    }

    #loadingText {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 18px;
      z-index: 1000;
      pointer-events: none;
    }
  </style>
</head>

<body style="margin:0;overflow:hidden">

  <!-- UI Elements -->
  <div id="loadingText">Detecting surfaces...</div>
  <button id="placeButton">Place Cube</button>

  <!-- A-Frame Scene -->
  <a-scene
    embedded
    arjs='trackingMethod: best;'
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <!-- Lighting -->
    <a-entity light="type: ambient; intensity: 0.5;"></a-entity>
    <a-entity light="type: directional; color: #fff; intensity: 0.7;" position="-1 1 0"></a-entity>

    <!-- Reticle for aiming -->
    <a-entity
      cursor="fuse: true; fuseTimeout: 500"
      position="0 0 -1"
      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
      material="color: yellow; shader: flat"
    ></a-entity>

    <!-- Hidden cube to be placed -->
    <a-box id="arCube"
      color="red"
      depth="0.5"
      height="0.5"
      width="0.5"
      visible="false"
    ></a-box>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- JavaScript Logic -->
  <script>
    window.addEventListener('load', () => {
      const scene = document.querySelector('a-scene');
      const cube = document.getElementById('arCube');
      const placeButton = document.getElementById('placeButton');
      const loadingText = document.getElementById('loadingText');

      let isPlaced = false;

      // Show button after delay to allow AR initialization
      setTimeout(() => {
        loadingText.innerText = "Tap the screen to place the cube.";
        placeButton.style.display = 'block';
      }, 3000);

      placeButton.addEventListener('click', () => {
        console.log("Place button clicked!");

        if (isPlaced) return;

        const cameraEl = document.querySelector('[camera]');
        const camera = cameraEl.getObject3D('camera');
        if (!camera) {
          alert("Camera not ready yet.");
          return;
        }

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2(0, 0); // Center of screen
        raycaster.setFromCamera(mouse, camera);

        const intersects = raycaster.intersectObjects(
          scene.object3D.children.filter(obj => obj.visible),
          true
        );

        if (intersects.length > 0) {
          const hitPoint = intersects[0].point;
          console.log("Hit point:", hitPoint);

          cube.setAttribute('position', {
            x: hitPoint.x,
            y: hitPoint.y + 0.25, // Slightly above ground
            z: hitPoint.z
          });

          cube.setAttribute('visible', true);
          placeButton.style.display = 'none';
          loadingText.innerText = "Cube placed!";
          isPlaced = true;
        } else {
          alert("No surface detected. Point at a flat area and try again.");
        }
      });
    });
  </script>
</body>
</html>
