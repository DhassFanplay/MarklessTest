<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AR.js Markerless Cube Placement</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js "></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js "></script>
  <style>
    body,
    html {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    #placeButton {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      font-size: 16px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      border-radius: 10px;
      z-index: 1000;
      display: none;
      cursor: pointer;
    }

    #loadingText {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      color: white;
      font-size: 18px;
      z-index: 1000;
      pointer-events: none;
    }

    a-scene {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
  </style>
</head>

<body style="margin:0;overflow:hidden">

  <!-- UI Elements -->
  <div id="loadingText">Detecting surfaces...</div>
  <button id="placeButton">Place Cube</button>

  <!-- A-Frame Scene -->
  <a-scene embedded arjs='trackingMethod: best;' vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    <!-- Lighting -->
    <a-entity light="type: ambient; intensity: 0.5;"></a-entity>
    <a-entity light="type: directional; color: #fff; intensity: 0.7;" position="-1 1 0"></a-entity>

    <!-- Reticle for aiming -->
    <a-entity
      id="reticle"
      cursor="fuse: true; fuseTimeout: 500"
      position="0 0 -1"
      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
      material="color: yellow; shader: flat"
    ></a-entity>

    <!-- Hidden cube to be placed -->
    <a-box id="arCube"
      color="red"
      depth="0.5"
      height="0.5"
      width="0.5"
      visible="false"
    ></a-box>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- JavaScript Logic -->
  <script>
    window.addEventListener('load', () => {
      const scene = document.querySelector('a-scene');
      const cube = document.getElementById('arCube');
      const placeButton = document.getElementById('placeButton');
      const loadingText = document.getElementById('loadingText');
      const reticle = document.getElementById('reticle');

      let isPlaced = false;

      // Show button after short delay
      setTimeout(() => {
        loadingText.innerText = "Tap the screen to place the cube.";
        placeButton.style.display = 'block';
      }, 3000);

      // Reticle auto-follow plane
      function updateReticle() {
        const arEl = scene.arSceneComponent;
        if (!arEl || !arEl.system.supportsHitTest) return;

        arEl.system.hitTest({ x: 0.5, y: 0.5 }).then((results) => {
          if (results.length > 0) {
            const hit = results[0];
            reticle.setAttribute('position', {
              x: hit.worldPosition.x,
              y: hit.worldPosition.y,
              z: hit.worldPosition.z
            });
          }
        });

        requestAnimationFrame(updateReticle);
      }

      updateReticle(); // Start updating reticle

      // Place cube when button clicked
      placeButton.addEventListener('click', () => {
        if (isPlaced) return;

        const arEl = scene.arSceneComponent;
        if (!arEl || !arEl.system.supportsHitTest) {
          alert("Hit test not supported on this device.");
          return;
        }

        arEl.system.hitTest({ x: 0.5, y: 0.5 }).then((results) => {
          if (results.length > 0) {
            const hit = results[0];

            cube.setAttribute('position', {
              x: hit.worldPosition.x,
              y: hit.worldPosition.y + 0.25,
              z: hit.worldPosition.z
            });

            cube.setAttribute('visible', true);
            placeButton.style.display = 'none';
            loadingText.innerText = "Cube placed!";
            isPlaced = true;
          } else {
            alert("No surface detected. Point at a flat area and try again.");
          }
        }).catch(() => {
          alert("Hit test failed. Try moving the camera around.");
        });
      });
    });
  </script>
</body>
</html>
